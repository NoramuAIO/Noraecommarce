generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  avatar    String?
  role      String   @default("user")
  status    String   @default("active")
  balance   Float    @default(0)
  discordId String?
  resetToken String?
  resetTokenExpiry DateTime?
  emailVerified Boolean @default(false)
  emailVerificationToken String?
  emailVerificationExpiry DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders    Order[]
  tickets   Ticket[]
  favorites Favorite[]
  referralsGiven Referral[] @relation("referrer")
  referralsReceived Referral[] @relation("referred")
}

model Category {
  id        Int       @id @default(autoincrement())
  name      String
  slug      String    @unique
  image     String?
  createdAt DateTime  @default(now())

  products  Product[]
  bundles   Bundle[]
}

model Product {
  id            Int      @id @default(autoincrement())
  name          String
  slug          String   @unique
  description   String
  longDescription String?
  price         Float
  originalPrice Float?
  image         String?
  version       String   @default("1.0.0")
  downloadUrl   String?
  licenseKey    String?
  minecraftVersions String @default("1.20,1.21")
  downloads     Int      @default(0)
  rating        Float    @default(5.0)
  reviews       Int      @default(0)
  badge         String?
  status        String   @default("active")
  // Yeni alanlar
  features      String?  // JSON array olarak özellikler
  requirements  String?  // JSON array olarak gereksinimler
  updatePolicy  String   @default("lifetime") // lifetime, 1year, 6months
  images        String?  // JSON array olarak ek resimler
  discordRoleId String?  // Bu ürünü alana verilecek Discord rol ID
  // SEO alanları
  seoTitle      String?
  seoDescription String?
  seoKeywords   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categoryId    Int
  category      Category @relation(fields: [categoryId], references: [id])

  orders        Order[]
  changelogs    ProductChangelog[]
  productReviews ProductReview[]
  favorites     Favorite[]
  coupons       Coupon[]  // Hangi kuponlar bu ürüne uygulanabilir
  bundles       Bundle[]  // Hangi bundleler bu ürüne uygulanabilir
  popupSettings PopupSettings?
}

model ProductChangelog {
  id          Int      @id @default(autoincrement())
  version     String
  changes     String   // JSON array
  createdAt   DateTime @default(now())

  productId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model ProductReview {
  id          Int      @id @default(autoincrement())
  rating      Int
  comment     String
  userName    String
  approved    Boolean  @default(false)
  createdAt   DateTime @default(now())

  productId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Order {
  id          Int      @id @default(autoincrement())
  orderNumber String   @unique
  amount      Float
  originalAmount Float?  // İndirim öncesi tutar
  discountAmount Float?  // İndirim tutarı
  status      String   @default("pending")
  paymentMethod String?
  createdAt   DateTime @default(now())

  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  productId   Int
  product     Product  @relation(fields: [productId], references: [id])

  couponId    Int?
  coupon      Coupon?  @relation(fields: [couponId], references: [id])
}

model BalancePackage {
  id          Int      @id @default(autoincrement())
  amount      Float
  bonus       Float    @default(0)
  price       Float
  popular     Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model BlogCategory {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  createdAt   DateTime @default(now())

  posts       BlogPost[]
}

model BlogPost {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  excerpt     String
  content     String
  image       String?
  author      String
  readTime    String   @default("5 dk")
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  Int?
  category    BlogCategory? @relation(fields: [categoryId], references: [id])
}

model FAQ {
  id          Int      @id @default(autoincrement())
  question    String
  answer      String
  category    String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
}

model Ticket {
  id          Int      @id @default(autoincrement())
  subject     String
  message     String
  category    String
  status      String   @default("open")
  priority    String   @default("normal")
  adminNote   String?  // Sadece admin panelinde görünür
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      Int
  user        User     @relation(fields: [userId], references: [id])

  replies     TicketReply[]
}

model TicketReply {
  id          Int      @id @default(autoincrement())
  message     String
  isAdmin     Boolean  @default(false)
  adminName   String?
  createdAt   DateTime @default(now())

  ticketId    Int
  ticket      Ticket   @relation(fields: [ticketId], references: [id])
}

model Settings {
  id              Int      @id @default(autoincrement())
  key             String   @unique
  value           String
  updatedAt       DateTime @updatedAt
}

model PopupSettings {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  buttonText      String   @default("Tıkla ve Ürünü İncele!")
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  productId       Int?    @unique
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
}

model EmailVerificationWhitelist {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

model Feature {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  icon        String
  color       String   @default("cyan")
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Testimonial {
  id          Int      @id @default(autoincrement())
  name        String
  role        String
  content     String
  rating      Int      @default(5)
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Reference {
  id          Int      @id @default(autoincrement())
  name        String
  image       String
  website     String?
  discord     String?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model Referral {
  id          Int      @id @default(autoincrement())
  referrerName String   // Referans veren kişinin adı
  referrerEmail String  // Referans veren kişinin e-postası
  referrerImage String? // Referans veren kişinin avatarı
  referrerWebsite String? // Referans veren kişinin websitesi
  referrerDiscord String? // Referans veren kişinin Discord
  status      String   @default("approved") // approved, rejected (otomatik approved)
  creditGiven Boolean  @default(false) // Kredi verildi mi?
  order       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  referrerId  Int
  referrer    User     @relation("referrer", fields: [referrerId], references: [id], onDelete: Cascade)

  referredId  Int
  referred    User     @relation("referred", fields: [referredId], references: [id], onDelete: Cascade)
}


model Favorite {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())

  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId   Int
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

model ProductNotification {
  id          Int      @id @default(autoincrement())
  type        String   // price_change, update, name_change, description_change, feature_change
  message     String
  oldValue    String?
  newValue    String?
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())

  userId      Int
  productId   Int
}


model LiveChat {
  id          Int      @id @default(autoincrement())
  sessionId   String   @unique
  userName    String?
  userEmail   String?
  userId      Int?
  status      String   @default("waiting") // waiting, active, closed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    LiveChatMessage[]
}

model LiveChatMessage {
  id          Int      @id @default(autoincrement())
  content     String
  isAdmin     Boolean  @default(false)
  adminName   String?
  createdAt   DateTime @default(now())

  chatId      Int
  chat        LiveChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
}


model Payment {
  id          Int      @id @default(autoincrement())
  merchantOid String   @unique
  amount      Float
  provider    String   // paytr, iyzico, papara
  status      String   @default("pending") // pending, completed, failed
  packageId   Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId      Int
}

model BalanceTransaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  amount      Float
  type        String   // add, subtract, set
  previousBalance Float
  newBalance  Float
  isRevenue   Boolean  @default(false)
  isExpense   Boolean  @default(false)
  note        String?
  adminId     Int?
  createdAt   DateTime @default(now())
}

model Coupon {
  id          Int      @id @default(autoincrement())
  code        String   @unique
  description String?
  discountType String  // percentage, fixed
  discountValue Float
  maxUses     Int?
  usedCount   Int      @default(0)
  expiresAt   DateTime?
  active      Boolean  @default(true)
  usableInCart Boolean  @default(false)  // Sepette kullanılabilir mi
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    Product[]  // Hangi ürünlere uygulanacak
  orders      Order[]    // Hangi siparişlerde kullanıldı
}

model Bundle {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  discountType String  // percentage, fixed
  discountValue Float
  applyTo     String   @default("category") // category, products
  expiresAt   DateTime?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  Int?
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  products    Product[]  // Seçili ürünler (applyTo: products ise)
}

model SiteLicense {
  id              Int      @id @default(autoincrement())
  licenseKey      String   @unique
  siteName        String
  domain          String
  serverIp        String?
  status          String   @default("active") // active, expired, suspended
  expiresAt       DateTime
  activations     Int      @default(0)
  maxActivations  Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
